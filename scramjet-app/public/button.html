<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Button</title>
    <link rel="stylesheet" href="button.css">
    <script src="/scram/scramjet.all.js"></script>
    <script src="/baremux/index.js" defer></script>
    <script src="/epoxy/index.js" defer></script>
    <script src="/register-sw.js" defer></script>
    <script src="/search.js" defer></script>
</head>
<body>
    <header class="header">

			<nav class="navbar">
				<a href="index.html">Home</a>
				<a href="button.html">Games</a>
				<a href="apps.html">Apps</a>
				<a href="#">About</a>
				<a href="#">Settings</a>
			</nav>
		</header>
    <div class="button-wrapper"></div>

    <iframe id="sj-frame" style="display: none;"></iframe>
    <div id="sj-close" onclick="closeProxy()">Ã—</div>

    <script>
        // Initialize proxy systems once and attach click handlers to all .open-proxy buttons
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // register service worker if possible
                await registerSW();
            } catch (err) {
                // non-fatal: SW may be blocked on http in some hosts
                console.warn('Service worker registration failed or skipped:', err);
            }

            // Create Scramjet controller once
            const { ScramjetController } = $scramjetLoadController();
            const scramjet = new ScramjetController({
                files: {
                    wasm: '/scram/scramjet.wasm.wasm',
                    all: '/scram/scramjet.all.js',
                    sync: '/scram/scramjet.sync.js',
                },
            });
            await scramjet.init();

            // BareMux connection & transport setup (copied from index.js behavior)
            const connection = new BareMux.BareMuxConnection('/baremux/worker.js');
            const wispUrl = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/wisp/';
            if ((await connection.getTransport()) !== '/epoxy/index.mjs') {
                await connection.setTransport('/epoxy/index.mjs', [{ wisp: wispUrl }]);
            }

            // Render cards from activities.json
            const wrapper = document.querySelector('.button-wrapper');
            try {
                const res = await fetch('activities.json', { cache: 'no-store' });
                const activities = await res.json();
                if (Array.isArray(activities)) {
                    activities.forEach((item) => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.dataset.url = item.url || '';
                        // Build content
                        const img = document.createElement('img');
                        img.src = item.image || '';
                        img.alt = item.name || '';
                        img.style.maxWidth = '100%';
                        img.style.borderRadius = '8px';
                        img.style.marginBottom = '12px';

                        const title = document.createElement('h1');
                        title.textContent = item.name || 'Untitled';

                        const btn = document.createElement('button');
                        btn.className = 'open-proxy';
                        btn.textContent = 'Open Proxy';

                        card.appendChild(img);
                        card.appendChild(title);
                        card.appendChild(btn);
                        wrapper.appendChild(card);
                    });
                }
            } catch (e) {
                console.warn('Failed to load activities.json', e);
            }

            // Delegate click handling for dynamically created buttons
            document.body.addEventListener('click', (ev) => {
                const targetEl = ev.target;
                if (!(targetEl instanceof HTMLElement)) return;
                if (!targetEl.classList.contains('open-proxy')) return;
                const card = targetEl.closest('.card');
                if (!card) return;
                const target = card.dataset.url;
                if (!target) return;

                const frame = document.getElementById('sj-frame');
                const encoded = scramjet.encodeUrl(target);
                frame.style.display = 'block';
                document.getElementById('sj-close').style.display = 'block';
                frame.src = encoded;
            });
        });

        function closeProxy() {
            const frame = document.getElementById('sj-frame');
            if (!frame) return;
            frame.style.display = 'none';
            try { frame.src = 'about:blank'; } catch (e) {}
            document.getElementById('sj-close').style.display = 'none';
        }
    </script>
</body>
</html>